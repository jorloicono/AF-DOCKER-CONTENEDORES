## Introducción a Amazon EKS

Este documento detalla los pasos para **desplegar una aplicación en Amazon Elastic Kubernetes Service (Amazon EKS)**, un servicio de **Kubernetes completamente administrado por AWS**.

**Amazon EKS** es un entorno confiable para ejecutar clústeres de Kubernetes de forma segura y escalable en AWS.

El proceso se enfoca en usar las herramientas **`eksctl`** y **`kubectl`** para crear el clúster, los grupos de nodos, el *Deployment* y el *Service*.

---

## Resumen de Actividades

El despliegue de la aplicación en EKS incluye los siguientes pasos:

1. Crear y subir la imagen a **Elastic Container Registry (ECR)**.  
2. Instalar **`kubectl`** y **`eksctl`**.  
3. Revisar el costo de un clúster EKS.  
4. Crear el Clúster y los Grupos de Nodos.  
5. Ejecutar el *Deployment*.  
6. Exponer el *Deployment*.  
7. Eliminar el Clúster.

---

## 1️⃣ Crear y Subir Imagen a ECR

Esta actividad requiere seguir los pasos de un laboratorio anterior, donde se detalla cómo subir una imagen a **Elastic Container Registry (ECR)**.  
(Ver documento: *11. Mi Primera Imagen en Amazon ECR*)

---

## 2️⃣ Instalación de Herramientas CLI

Para este proceso, se necesitan las herramientas:

- **AWS CLI**  
- **`kubectl` CLI**  
- **`eksctl` CLI**

**Buena noticia:** En **AWS CloudShell**, todas estas herramientas ya vienen **preinstaladas y configuradas**.

---

## 3️⃣ Costo del Clúster EKS 

Amazon EKS **no se encuentra dentro de la capa gratuita** de AWS.

- **EKS Cluster (Plano de Control):**  
  $0.10 por hora por cada clúster de Amazon EKS.  

- **EKS Worker Nodes (EC2):**  
  Se paga por los recursos usados, como las instancias EC2 o los volúmenes EBS.  
  Por ejemplo, una instancia **t3.medium** cuesta aproximadamente **$0.0416 por hora** en N. Virginia.

**Costo estimado diario:**  
Un clúster con **1 EKS Cluster** y **2 Worker Nodes t3.medium** durante un día cuesta aproximadamente **$3.4 USD**.

---

## 4️⃣ Crear Clúster y Grupos de Nodos

Usaremos **`eksctl`**, una herramienta de línea de comandos simple para crear y administrar clústeres de EKS.

> ⏱️ Tiempo estimado de creación: entre **10 y 15 minutos**.

---

### A. Creación del Clúster

Crea un clúster llamado `eksdemo1` **sin grupo de nodos inicial**:

```bash
eksctl create cluster --name=eksdemo1 \
--region us-east-1 \
--zones us-east-1a,us-east-1b \
--without-nodegroup
````

---

### B. Asociación del Proveedor IAM OIDC

Se crea y asocia el proveedor OIDC (OpenID Connect) de IAM al clúster EKS:

```bash
eksctl utils associate-iam-oidc-provider \
--region us-east-1 \
--cluster eksdemo1 \
--approve
```

---

### C. Creación del Grupo de Nodos

Se crea un **grupo de nodos administrados** por Amazon EKS (Worker Nodes).
Una vez que los nodos se unan al clúster, podrás implementar aplicaciones Kubernetes en ellos.

> **Consejo:** Usa la opción `--ssh-public-key` para habilitar el acceso SSH a los nodos, útil para diagnóstico.

```bash
eksctl create nodegroup --cluster=eksdemo1 \
--region us-east-1 \
--name=eksdemo1-ng-public1 \
--node-type t3.medium \
--nodes 2 \
--nodes-min 2 \
--nodes-max 4 \
--node-volume-size 20 \
--ssh-access \
--ssh-public-key=kube-demo \
--managed \
--asg-access \
--external-dns-access \
--full-ecr-access \
--appmesh-access \
--alb-ingress-access
```

---

## 5️⃣ Ejecutar el Deployment y Exponer el Servicio

Con el clúster listo, se crean y aplican los archivos **YAML** de manifiesto de Kubernetes usando `kubectl`.

---

### A. Ejecutar el Deployment

Crea el archivo `02-deployment-definition.yml` con el siguiente contenido:
(Asegúrate de reemplazar la **URI de la imagen** con la tuya propia si es diferente.)

```yaml
cat > 02-deployment-definition.yml <<EOF
apiVersion: apps/v1
kind: Deployment
metadata:
  name: myapp-deployment
spec:
  replicas: 3
  selector:
    matchLabels:
      app: myapp
  template:
    metadata:
      name: myapp-pod
      labels:
        app: myapp
    spec:
      containers:
      - name: myapp-container
        image: 818929933852.dkr.ecr.us-east-1.amazonaws.com/demo-ninja:latest
        ports:
          - containerPort: 80
EOF
```

Aplica el *Deployment*:

```bash
kubectl apply -f 02-deployment-definition.yml
```

---

### B. Exponer el Servicio (NodePort)

Crea el archivo `03-deployment-nodeport-service.yml` para exponer la aplicación mediante un **NodePort** (puerto `31233`):

```yaml
cat > 03-deployment-nodeport-service.yml <<EOF
apiVersion: v1
kind: Service
metadata:
  name: deployment-nodeport-service
spec:
  type: NodePort
  selector:
    app: myapp
  ports:
  - name: http
    port: 80
    targetPort: 80
    nodePort: 31233
EOF
```

Aplica el *Service*:

```bash
kubectl apply -f 03-deployment-nodeport-service.yml
```

---

### C. Verificar Servicio y Nodos

Lista el servicio y los nodos para obtener las IP públicas:

```bash
kubectl get svc
kubectl get nodes -o wide
```

La salida mostrará el servicio `deployment-nodeport-service` con el puerto `80:31233/TCP`
y las **IP públicas (EXTERNAL-IP)** de los nodos de trabajo.

---

### D. Acceso a la Aplicación

Antes de acceder, **modifica el Security Group del Node Group** para permitir tráfico de entrada (**All TCP**).

Con la **IP pública** de un nodo y el **puerto NodePort (31233)**, podrás acceder a la aplicación desde un navegador:

**Ejemplo de URL:**

```
http://3.91.54.205:31233
```

Al acceder, verás la aplicación:

> **Bienvenido al Taller Ninja**
> Ninja Project - BBVA
> Application Version: V1

---

## 7️⃣ Eliminar el Clúster 

Para evitar costos adicionales, elimina el clúster y los grupos de nodos cuando termines:

```bash
eksctl delete cluster --name=eksdemo1 --region=us-east-1
```

---

## Resultado Final

Has desplegado exitosamente una aplicación en **Amazon EKS** utilizando:

* `eksctl` para crear la infraestructura.
* `kubectl` para aplicar los manifiestos.
* Una imagen previamente subida a **Amazon ECR**.



¿Quieres que te genere el archivo `.md` descargable (por ejemplo, `Despliegue_EKS.md`)? Puedo crearlo ahora mismo para que lo bajes directamente.
```
